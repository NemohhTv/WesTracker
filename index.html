<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Content Spend Tracker Pro</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  :root {
    --bg: #09090b; --surface: #18181b; --surface-hover: #27272a; 
    --border: #3f3f46; --text: #f4f4f5; --muted: #a1a1aa; 
    --primary: #3b82f6; --primary-hover: #2563eb;
    --danger: #ef4444; --success: #10b981; 
    --yt: #ff0000; --tt: #00f2ea;
    --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.5), 0 2px 4px -2px rgb(0 0 0 / 0.5);
  }

  body { 
    margin: 0; background: var(--bg); color: var(--text); 
    font-family: 'Inter', sans-serif; font-size: 14px; 
    -webkit-font-smoothing: antialiased;
  }
  * { box-sizing: border-box; }

  /* --- LAYOUT --- */
  .container { max-width: 1280px; margin: 0 auto; padding: 24px; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
  .header h1 { margin: 0; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
  .controls { display: flex; gap: 10px; flex-wrap: wrap; }
  
  /* --- UI ELEMENTS --- */
  button, input, textarea {
    background: var(--surface); border: 1px solid var(--border); color: var(--text);
    padding: 10px 16px; border-radius: 8px; font-family: inherit; font-size: 13px; font-weight: 500;
    transition: all 0.2s ease; outline: none;
  }
  button { cursor: pointer; box-shadow: var(--shadow); }
  button:hover { background: var(--surface-hover); border-color: var(--muted); }
  button.primary { background: var(--primary); border-color: var(--primary); color: white; }
  button.primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }
  button.cloud { background: rgba(99, 102, 241, 0.1); border-color: #6366f1; color: #818cf8; }
  button.cloud:hover { background: #6366f1; color: white; }
  button.icon-btn { padding: 6px 10px; background: transparent; border: none; color: var(--muted); box-shadow: none; }
  button.icon-btn:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
  input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
  
  /* --- STATS GRID --- */
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); }
  .stat-label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; display: block; margin-bottom: 8px; }
  .stat-val { font-size: 28px; font-weight: 700; }
  .text-success { color: var(--success); }

  /* --- DATA TABLE --- */
  .table-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; }
  .table-wrap { overflow-x: auto; width: 100%; }
  table { width: 100%; border-collapse: collapse; min-width: 800px; }
  thead { background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid var(--border); }
  th { padding: 16px; text-align: left; font-size: 12px; color: var(--muted); font-weight: 600; text-transform: uppercase; cursor: pointer; user-select: none; transition: color 0.2s; }
  th:hover { color: var(--text); }
  td { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255, 255, 255, 0.01); }
  
  .media-cell { display: flex; align-items: center; gap: 16px; }
  .thumb { width: 96px; height: 54px; background: #000; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
  .thumb-placeholder { width: 96px; height: 54px; background: #27272a; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: var(--muted); }
  .row-title { font-weight: 600; font-size: 14px; color: var(--text); text-decoration: none; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; max-width: 300px; line-height: 1.4; }
  .row-title:hover { color: var(--primary); }
  .row-meta { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
  .row-chan { font-size: 12px; color: var(--muted); }
  
  .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .badge-yt { background: rgba(255, 0, 0, 0.15); color: #ff6b6b; border: 1px solid rgba(255, 0, 0, 0.2); }
  .badge-tt { background: rgba(0, 242, 234, 0.15); color: var(--tt); border: 1px solid rgba(0, 242, 234, 0.2); }

  td input[type="text"], td input[type="number"], td input[type="date"] {
    background: transparent; border: 1px solid transparent; padding: 6px 8px; border-radius: 4px; box-shadow: none; width: 100%; font-variant-numeric: tabular-nums;
  }
  td input:hover, td input:focus { background: rgba(255,255,255,0.05); border-color: var(--border); }
  td input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--success); cursor: pointer; }

  /* --- MODALS --- */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; } 
  
  /* UPDATED MODAL BOX FOR WIDER VIEW */
  .modal-box { 
    background: var(--surface); 
    border: 1px solid var(--border); 
    border-radius: 16px; 
    width: 90%; 
    max-width: 800px; /* Increased from 600px */
    max-height: 95vh; 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); 
  }
  
  .modal-head { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .modal-head h3 { margin: 0; font-size: 18px; }
  .modal-body { padding: 32px; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; gap: 32px; }
  .modal-foot { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; background: rgba(0,0,0,0.2); border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }

  .settings-section { display: flex; flex-direction: column; gap: 16px; width: 100%; }
  .settings-section h4 { margin: 0; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
  .input-group { display: flex; flex-direction: column; gap: 8px; }
  .input-group label { font-size: 13px; color: var(--muted); }

  /* --- TOAST --- */
  #toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--border); border-left: 4px solid var(--primary); padding: 16px 24px; border-radius: 8px; font-weight: 500; transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 1000; box-shadow: var(--shadow); }
  #toast.show { transform: translateY(0); }
  #toast.success { border-left-color: var(--success); }
  #toast.error { border-left-color: var(--danger); }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Content Spend Tracker</h1>
    <div class="controls">
      <button onclick="app.sync()" id="btnSync" class="primary">
        <svg style="width:14px;height:14px;vertical-align:middle;margin-right:6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
        Sync YouTube
      </button>
      <button onclick="app.addLink()">+ Add Link</button>
      <button onclick="app.cloudBackup()" class="cloud">☁ Cloud Backup</button>
      <button onclick="ui.openModal('modalSettings')">⚙ Settings</button>
      <button onclick="app.togglePaid()" id="btnPaid">Hide Paid</button>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <span class="stat-label">Pending Payout</span>
      <span class="stat-val text-success" id="s-unpaid">$0.00</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Total Paid</span>
      <span class="stat-val" id="s-paid" style="color:var(--muted)">$0.00</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Lifetime Spend</span>
      <span class="stat-val" id="s-total">$0.00</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Total Videos</span>
      <span class="stat-val" id="s-count">0</span>
    </div>
  </div>

  <div class="table-card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th onclick="app.sort('title')" style="width:40%">Content Info ↕</th>
            <th onclick="app.sort('sec')" style="width:12%">Duration ↕</th>
            <th onclick="app.sort('price')" style="width:12%">Price ($) ↕</th>
            <th onclick="app.sort('date')" style="width:15%">Date ↕</th>
            <th onclick="app.sort('paid')" style="width:10%; text-align:center;">Paid ↕</th>
            <th style="width:10%; text-align:center;">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modalSettings" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Configuration</h3>
      <button class="icon-btn" onclick="ui.closeModal('modalSettings')">✕</button>
    </div>
    <div class="modal-body">
      
      <div class="settings-section">
        <h4>API & Cloud Integrations</h4>
        <input type="password" id="inpApiKey" placeholder="YouTube Data API v3 Key">
        <div style="display:flex; gap:10px;">
          <input type="password" id="inpGhToken" placeholder="GitHub PAT (for Backup)" style="flex:1">
          <input type="text" id="inpGhRepo" placeholder="Repo (e.g. username/tracker)" style="flex:1">
        </div>
      </div>

      <div class="settings-section">
        <h4>YouTube Auto-Pricing (Mins)</h4>
        <div class="grid-3">
          <div class="input-group"><label>8 mins ($)</label><input type="number" id="price8"></div>
          <div class="input-group"><label>9 mins ($)</label><input type="number" id="price9"></div>
          <div class="input-group"><label>10+ mins ($)</label><input type="number" id="price10"></div>
        </div>
      </div>

      <div class="settings-section">
        <h4>TikTok Auto-Pricing (Secs)</h4>
        <div class="grid-3">
          <div class="input-group"><label>Up to 15s ($)</label><input type="number" id="tt15"></div>
          <div class="input-group"><label>Up to 60s ($)</label><input type="number" id="tt60"></div>
          <div class="input-group"><label>2m+ ($)</label><input type="number" id="tt120"></div>
        </div>
      </div>

      <div class="settings-section">
        <h4>Tracked Channels (YouTube)</h4>
        <div id="chanList" style="display:flex; flex-direction:column; gap:8px; background:rgba(0,0,0,0.2); padding:16px; border-radius:8px; border:1px solid var(--border);"></div>
        <div style="display:flex; gap:10px; margin-top:4px;">
          <input id="inpNewChan" style="flex:1" placeholder="@WesNemo or Channel ID">
          <button class="primary" onclick="app.addChannel()">Add</button>
        </div>
      </div>

      <div class="settings-section">
        <h4>Data Management</h4>
        <div style="display:flex; gap:10px;">
          <button onclick="app.exportCSV()" style="flex:1">Export CSV</button>
          <button onclick="app.promptImport()" style="flex:1">Import JSON</button>
        </div>
      </div>

    </div>
    <div class="modal-foot">
      <button onclick="ui.closeModal('modalSettings')">Cancel</button>
      <button class="primary" onclick="app.saveSettings()">Save Changes</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const STORAGE_KEY = 'CST_PRO_V2';

// ----------------------------------------------------
// YOUR INJECTED DATA FROM THE OLD SITE
// ----------------------------------------------------
const INJECTED_DATA = {
  key: "AIzaSyCdPao1_MPb5GRRMP50VsXvSfHMd1Cb9AU",
  ghToken: '', ghRepo: '',
  channels: [
    {"id":"UC_0tF7T80UwDr5ZdFUluurg","name":"WesWorld","uploads":"UU_0tF7T80UwDr5ZdFUluurg"},
    {"id":"UCr-DanLYTTqVDoviyjwP4mQ","name":"WesNemoTV","uploads":"UUr-DanLYTTqVDoviyjwP4mQ"}
  ],
  prices: {"p8":20,"p9":25,"p10":30},
  ttPrices: { t15: 10, t60: 15, t120: 25 },
  videos: [
    {"id":"GsqWIX1CpB0","platform":"youtube","url":"https://youtu.be/GsqWIX1CpB0","title":"Star Wars is Changing Forever...","chan":"WesWorld","date":"2026-01-09","thumb":"https://i.ytimg.com/vi/GsqWIX1CpB0/mqdefault.jpg","sec":593,"price":25,"paid":true},
    {"id":"EonAo5WghSI","platform":"youtube","url":"https://youtu.be/EonAo5WghSI","title":"Lord of the Rings Movie HUGE NEWS...","chan":"WesWorld","date":"2026-01-07","thumb":"https://i.ytimg.com/vi/EonAo5WghSI/mqdefault.jpg","sec":597,"price":30,"paid":true},
    {"id":"Ge2k0q5pFaA","platform":"youtube","url":"https://youtu.be/Ge2k0q5pFaA","title":"Spider-Man 4 TRAILER RELEASE...","chan":"WesWorld","date":"2026-01-03","thumb":"https://i.ytimg.com/vi/Ge2k0q5pFaA/mqdefault.jpg","sec":539,"price":25,"paid":true},
    {"id":"GpQ3FZ-H_Z4","platform":"youtube","url":"https://youtu.be/GpQ3FZ-H_Z4","title":"Harry Potter Show HUGE NEWS...","chan":"WesWorld","date":"2026-01-01","thumb":"https://i.ytimg.com/vi/GpQ3FZ-H_Z4/mqdefault.jpg","sec":525,"price":20,"paid":true},
    {"id":"iv5vIY5IRSw","platform":"youtube","url":"https://youtu.be/iv5vIY5IRSw","title":"Star Trek Reboot BIG NEWS...","chan":"WesWorld","date":"2025-12-30","thumb":"https://i.ytimg.com/vi/iv5vIY5IRSw/mqdefault.jpg","sec":593,"price":40,"paid":true},
    {"id":"mKjx_YX5-vs","platform":"youtube","url":"https://youtu.be/mKjx_YX5-vs","title":"Lord of the Rings Game HUGE LEAK...","chan":"WesNemoTV","date":"2025-12-31","thumb":"https://i.ytimg.com/vi/mKjx_YX5-vs/mqdefault.jpg","sec":589,"price":25,"paid":true},
    {"id":"sO-LWC1JdiE","platform":"youtube","url":"https://youtu.be/sO-LWC1JdiE","title":"Bioshock 4 HUGE LEAK...","chan":"WesNemoTV","date":"2025-12-28","thumb":"https://i.ytimg.com/vi/sO-LWC1JdiE/mqdefault.jpg","sec":592,"price":25,"paid":true},
    {"id":"wH7kGZ-b6fA","platform":"youtube","url":"https://youtu.be/wH7kGZ-b6fA","title":"Lord of the Rings Movie BIG NEWS...","chan":"WesWorld","date":"2026-01-11","thumb":"https://i.ytimg.com/vi/wH7kGZ-b6fA/mqdefault.jpg","sec":543,"price":25,"paid":true},
    {"id":"NWmJXFbXDss","platform":"youtube","url":"https://youtu.be/NWmJXFbXDss","title":"Prince of Persia Remake HUGE LEAK...","chan":"WesNemoTV","date":"2026-01-14","thumb":"https://i.ytimg.com/vi/NWmJXFbXDss/mqdefault.jpg","sec":588,"price":25,"paid":true},
    {"id":"xMKE8RAU1SU","platform":"youtube","url":"https://youtu.be/xMKE8RAU1SU","title":"Star Wars BIG UPDATE...","chan":"WesWorld","date":"2026-01-17","thumb":"https://i.ytimg.com/vi/xMKE8RAU1SU/mqdefault.jpg","sec":581,"price":25,"paid":true},
    {"id":"tTxW2TMrKr4","platform":"youtube","url":"https://youtu.be/tTxW2TMrKr4","title":"Star Trek Reboot HUGE NEWS...","chan":"WesWorld","date":"2026-01-22","thumb":"https://i.ytimg.com/vi/tTxW2TMrKr4/mqdefault.jpg","sec":579,"price":25,"paid":true},
    {"id":"RXMhe2s_xpo","platform":"youtube","url":"https://youtu.be/RXMhe2s_xpo","title":"Marvel's Wolverine HUGE NEWS...","chan":"WesNemoTV","date":"2026-02-01","thumb":"https://i.ytimg.com/vi/RXMhe2s_xpo/mqdefault.jpg","sec":523,"price":30,"paid":true},
    {"id":"iGfH1SfQvlM","platform":"youtube","url":"https://youtu.be/iGfH1SfQvlM","title":"Harry Potter Show BIG NEWS...","chan":"WesWorld","date":"2026-02-02","thumb":"https://i.ytimg.com/vi/iGfH1SfQvlM/mqdefault.jpg","sec":602,"price":30,"paid":true},
    {"id":"EOZYUsZirrs","platform":"youtube","url":"https://youtu.be/EOZYUsZirrs","title":"Final Fantasy 7 Remake Part 3 BIG REVEAL...","chan":"WesNemoTV","date":"2026-02-04","thumb":"https://i.ytimg.com/vi/EOZYUsZirrs/mqdefault.jpg","sec":504,"price":20,"paid":true},
    {"id":"fFLWD_WOzuY","platform":"youtube","url":"https://youtu.be/fFLWD_WOzuY","title":"Pirates of the Caribbean 6 HUGE NEWS...","chan":"WesWorld","date":"2026-02-07","thumb":"https://i.ytimg.com/vi/fFLWD_WOzuY/mqdefault.jpg","sec":540,"price":25,"paid":true},
    {"id":"OgcIU1WhxJ8","platform":"youtube","url":"https://youtu.be/OgcIU1WhxJ8","title":"Baldurs Gate 3 Show BIG NEWS...","chan":"WesWorld","date":"2026-02-10","thumb":"https://i.ytimg.com/vi/OgcIU1WhxJ8/mqdefault.jpg","sec":584,"price":25,"paid":true},
    {"id":"YCiJ3hz1QBg","platform":"youtube","url":"https://youtu.be/YCiJ3hz1QBg","title":"Harry Potter Show HUGE LEAK...","chan":"WesWorld","date":"2026-02-08","thumb":"https://i.ytimg.com/vi/YCiJ3hz1QBg/mqdefault.jpg","sec":586,"price":25,"paid":true},
    {"id":"eePSaKUn0hg","platform":"youtube","url":"https://youtu.be/eePSaKUn0hg","title":"Lord of the Rings Movie HUGE NEWS...","chan":"WesWorld","date":"2026-02-11","thumb":"https://i.ytimg.com/vi/eePSaKUn0hg/mqdefault.jpg","sec":591,"price":25,"paid":true},
    {"id":"IEx5lSfqhHk","platform":"youtube","url":"https://youtu.be/IEx5lSfqhHk","title":"The Mummy 4 HUGE NEWS...","chan":"WesWorld","date":"2026-02-14","thumb":"https://i.ytimg.com/vi/IEx5lSfqhHk/mqdefault.jpg","sec":556,"price":25,"paid":true}
  ],
  ignored: ["QNn3nt6nPu4","MoAt27LRmMw","c5zBf5VwoBE","dYZ9tzC4DMM","hI_v5kXg-Zc","HK3P290lUjI","lILkujIjE60","gOed0WyNFoE","RdPozJn5vRs","CQ7i8zo4v5Q","EfBL1HGDAaw","1UACE-ZjYjQ","SLOQKlIuJAo","IP3YaIP4Cuo","n7D0zmDr_KA","6saLhUHzp_Y","VbbX48IBUos","-GYTqmQM86k","zbbyR_xXgAc","ZnT4IlxHOKY","L_c4txevhK0","EoQ5Po-yvfw","iPCoCmOzgfc","h1rrz6ZZ3rU"],
  hidePaid: true,
  sortField: "date",
  sortDesc: true
};

const db = {
  data: {},
  load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) {
      this.data = JSON.parse(raw);
    } else {
      // First time loading the new site? Inject the hardcoded data!
      this.data = INJECTED_DATA;
      this.save();
    }
  },
  save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data)); }
};

const api = {
  async ytReq(endpoint, params) {
    if(!db.data.key) throw new Error("Missing YouTube API Key.");
    const url = new URL(`https://www.googleapis.com/youtube/v3/${endpoint}`);
    url.search = new URLSearchParams({ key: db.data.key, ...params });
    const res = await fetch(url);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message);
    return json;
  },
  async ttEmbed(url) {
    const res = await fetch(`https://www.tiktok.com/oembed?url=${encodeURIComponent(url)}`);
    if(!res.ok) throw new Error("Failed to fetch TikTok data");
    return await res.json();
  }
};

const app = {
  init() { 
    db.load(); 
    ui.initInputs(); 
    this.render(); 
  },
  
  render() { 
    ui.renderTable(); 
    ui.renderStats(); 
    ui.renderChannels(); 
    document.getElementById('btnPaid').textContent = db.data.hidePaid ? "Show Paid" : "Hide Paid";
  },

  parseTimeStr(str) {
    if(!str) return 0;
    const parts = str.split(':');
    if(parts.length === 1) return parseInt(parts[0]) || 0;
    return (parseInt(parts[0]) || 0) * 60 + (parseInt(parts[1]) || 0);
  },

  calculatePrice(platform, totalSeconds) {
    if(totalSeconds === 0) return 0;
    if(platform === 'youtube') {
      const mins = Math.floor(totalSeconds / 60);
      if(mins >= 10) return db.data.prices.p10;
      if(mins === 9) return db.data.prices.p9;
      if(mins === 8) return db.data.prices.p8;
      return 0; 
    } 
    if(platform === 'tiktok') {
      if(totalSeconds >= 120) return db.data.ttPrices.t120;
      if(totalSeconds >= 60) return db.data.ttPrices.t60;
      return db.data.ttPrices.t15;
    }
    return 0;
  },

  async addLink() {
    const url = prompt("Paste YouTube or TikTok URL:");
    if(!url) return;

    if(url.includes('tiktok.com') || url.includes('vm.tiktok.com')) {
      ui.toast("Extracting TikTok data...", "info");
      try {
        const meta = await api.ttEmbed(url);
        db.data.videos.push({
          id: 'tt_' + Date.now(),
          platform: 'tiktok',
          url: url,
          title: meta.title || "TikTok Content",
          chan: meta.author_name || "Unknown",
          date: new Date().toISOString().split('T')[0],
          thumb: '', 
          sec: 0, 
          price: 0, 
          paid: false
        });
        db.save(); 
        this.render();
        ui.toast("TikTok added! Enter duration to auto-price.", "success");
      } catch(e) { ui.toast("TikTok fetch failed. Link might be private.", "error"); }
    } else {
      const match = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
      if(!match) return ui.toast("Invalid YouTube URL", "error");
      try {
        const data = await api.ytReq('videos', { part: 'snippet,contentDetails', id: match[1] });
        if(data.items.length) {
          if(!db.data.videos.some(x => x.id === data.items[0].id)) {
            db.data.videos.push(this.processYT(data.items[0]));
            db.save(); this.render();
            ui.toast("YouTube video added!", "success");
          } else {
            ui.toast("Video already exists.", "info");
          }
        }
      } catch(e) { ui.toast(e.message, "error"); }
    }
  },

  processYT(item) {
    const d = item.contentDetails.duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
    const sec = ((parseInt(d[1])||0)*3600) + ((parseInt(d[2])||0)*60) + (parseInt(d[3])||0);
    return {
      id: item.id,
      platform: 'youtube',
      url: `https://youtu.be/${item.id}`,
      title: item.snippet.title,
      chan: item.snippet.channelTitle,
      date: item.snippet.publishedAt.slice(0,10),
      thumb: item.snippet.thumbnails?.medium?.url,
      sec: sec,
      price: this.calculatePrice('youtube', sec),
      paid: false
    };
  },

  async sync() {
    if(!db.data.channels.length) return ui.toast("Add channels in Settings first.", "error");
    const btn = document.getElementById('btnSync');
    btn.disabled = true; btn.innerHTML = "Syncing...";
    try {
      let newCount = 0;
      for(const ch of db.data.channels) {
        const pl = await api.ytReq('playlistItems', { playlistId: ch.uploads, maxResults: 15, part: 'contentDetails' });
        const ids = pl.items.map(x => x.contentDetails.videoId);
        const needed = ids.filter(id => !db.data.videos.some(v => v.id === id) && !db.data.ignored.includes(id));
        
        if(needed.length) {
          const details = await api.ytReq('videos', { part: 'snippet,contentDetails', id: needed.join(',') });
          details.items.forEach(d => { db.data.videos.push(this.processYT(d)); newCount++; });
        }
      }
      db.save(); this.render();
      ui.toast(newCount > 0 ? `Synced ${newCount} new videos.` : "All up to date.", "success");
    } catch(e) { ui.toast(e.message, "error"); }
    btn.disabled = false; btn.innerHTML = `
      <svg style="width:14px;height:14px;vertical-align:middle;margin-right:6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
      Sync YouTube
    `;
  },

  handleDurationEdit(id, timeStr) {
    const v = db.data.videos.find(x => x.id === id);
    if(v) {
      v.sec = this.parseTimeStr(timeStr);
      v.price = this.calculatePrice(v.platform, v.sec);
      db.save();
      this.render(); 
    }
  },

  updateRow(id, field, val) {
    const v = db.data.videos.find(x => x.id === id);
    if(v) { 
      v[field] = val; 
      db.save(); 
      ui.renderStats(); 
    }
  },

  deleteRow(id) {
    if(confirm("Remove this entry?")) {
      const v = db.data.videos.find(x => x.id === id);
      if(v && v.platform === 'youtube') db.data.ignored.push(id);
      db.data.videos = db.data.videos.filter(x => x.id !== id);
      db.save(); this.render();
    }
  },

  async cloudBackup() {
    if(!db.data.ghToken || !db.data.ghRepo) {
      ui.openModal('modalSettings');
      return ui.toast("Configure GitHub Token & Repo first.", "error");
    }
    ui.toast("Triggering Cloud Backup...", "info");
    try {
      const response = await fetch(`https://api.github.com/repos/${db.data.ghRepo}/dispatches`, {
        method: "POST",
        headers: {
          "Authorization": `token ${db.data.ghToken}`,
          "Accept": "application/vnd.github.v3+json",
        },
        body: JSON.stringify({ event_type: "cloud_backup", client_payload: { data: JSON.stringify(db.data) } })
      });
      if(response.ok) ui.toast("Backup successfully dispatched to GitHub!", "success");
      else throw new Error("API Rejected request");
    } catch(e) { ui.toast("Backup failed. Check Token/Repo config.", "error"); }
  },

  async addChannel() {
    const val = document.getElementById('inpNewChan').value.trim();
    if(!val) return;
    try {
      const res = await api.ytReq('channels', { part: 'snippet,contentDetails', forHandle: val.startsWith('@') ? val : undefined, id: !val.startsWith('@') ? val : undefined });
      const item = res.items[0];
      if(!db.data.channels.some(c => c.id === item.id)) {
        db.data.channels.push({ id: item.id, name: item.snippet.title, uploads: item.contentDetails.relatedPlaylists.uploads });
        db.save(); ui.renderChannels();
        document.getElementById('inpNewChan').value = '';
      }
    } catch(e) { ui.toast("Channel not found", "error"); }
  },

  removeChannel(idx) { db.data.channels.splice(idx, 1); db.save(); ui.renderChannels(); },
  
  saveSettings() {
    db.data.key = document.getElementById('inpApiKey').value;
    db.data.ghToken = document.getElementById('inpGhToken').value;
    db.data.ghRepo = document.getElementById('inpGhRepo').value;
    db.data.prices = { p8: parseFloat(document.getElementById('price8').value)||0, p9: parseFloat(document.getElementById('price9').value)||0, p10: parseFloat(document.getElementById('price10').value)||0 };
    db.data.ttPrices = { t15: parseFloat(document.getElementById('tt15').value)||0, t60: parseFloat(document.getElementById('tt60').value)||0, t120: parseFloat(document.getElementById('tt120').value)||0 };
    db.save(); ui.closeModal('modalSettings'); ui.toast("Settings Saved", "success");
  },

  togglePaid() { db.data.hidePaid = !db.data.hidePaid; db.save(); this.render(); },
  sort(f) { if(db.data.sortField === f) db.data.sortDesc = !db.data.sortDesc; else { db.data.sortField = f; db.data.sortDesc = true; } db.save(); this.render(); },
  
  exportCSV() {
    let csv = "Date,Platform,Title,Channel,Duration_Secs,Price,Paid\n";
    db.data.videos.forEach(v => { csv += `${v.date},${v.platform},"${v.title.replace(/"/g,'""')}",${v.chan},${v.sec},${v.price},${v.paid}\n`; });
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = 'spend_tracker_export.csv'; a.click();
  },

  promptImport() {
    const raw = prompt("Paste your exported JSON backup string here:");
    if(raw) {
      try {
        const parsed = JSON.parse(raw);
        if(parsed.videos || parsed.data) { 
          const extract = parsed.data ? parsed.data : parsed;
          db.data = {...db.data, ...extract}; 
          db.save(); 
          location.reload(); 
        } else {
           ui.toast("String format not recognized.", "error");
        }
      } catch(e) { ui.toast("Invalid JSON string.", "error"); }
    }
  }
};

const ui = {
  fmtMoney: new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' }),
  fmtTime(sec) { 
    if(!sec || sec === 0) return ""; 
    return `${Math.floor(sec/60)}:${(sec % 60).toString().padStart(2,'0')}`; 
  },
  
  initInputs() {
    document.getElementById('inpApiKey').value = db.data.key;
    document.getElementById('inpGhToken').value = db.data.ghToken || '';
    document.getElementById('inpGhRepo').value = db.data.ghRepo || '';
    document.getElementById('price8').value = db.data.prices.p8;
    document.getElementById('price9').value = db.data.prices.p9;
    document.getElementById('price10').value = db.data.prices.p10;
    document.getElementById('tt15').value = db.data.ttPrices.t15;
    document.getElementById('tt60').value = db.data.ttPrices.t60;
    document.getElementById('tt120').value = db.data.ttPrices.t120;
  },

  renderStats() {
    let un = 0, pd = 0;
    db.data.videos.forEach(v => { const p = parseFloat(v.price)||0; if(v.paid) pd += p; else un += p; });
    document.getElementById('s-unpaid').textContent = this.fmtMoney.format(un);
    document.getElementById('s-paid').textContent = this.fmtMoney.format(pd);
    document.getElementById('s-total').textContent = this.fmtMoney.format(un + pd);
    document.getElementById('s-count').textContent = db.data.videos.length;
  },

  renderChannels() {
    const list = document.getElementById('chanList');
    if(db.data.channels.length === 0) list.innerHTML = `<div style="color:var(--muted);font-size:12px;">No channels tracked.</div>`;
    else list.innerHTML = db.data.channels.map((c, i) => `<div style="display:flex; justify-content:space-between; align-items:center;"><span><span style="font-weight:600;">${c.name}</span> <span style="font-size:10px;color:var(--muted)">${c.id}</span></span><button class="icon-btn" onclick="app.removeChannel(${i})">✕</button></div>`).join('');
  },

  renderTable() {
    const tb = document.getElementById('tbody');
    let list = [...db.data.videos];
    if(db.data.hidePaid) list = list.filter(v => !v.paid);
    
    const f = db.data.sortField;
    const m = db.data.sortDesc ? -1 : 1;
    list.sort((a,b) => (a[f] > b[f] ? m : -m));

    tb.innerHTML = list.map(v => `
      <tr>
        <td>
          <div class="media-cell">
            ${v.thumb ? `<img src="${v.thumb}" class="thumb">` : `<div class="thumb-placeholder">${v.platform === 'tiktok' ? 'TT' : 'YT'}</div>`}
            <div>
              <a href="${v.url}" target="_blank" class="row-title">${v.title}</a>
              <div class="row-meta">
                <span class="badge ${v.platform === 'tiktok' ? 'badge-tt' : 'badge-yt'}">${v.platform || 'yt'}</span>
                <span class="row-chan">${v.chan}</span>
              </div>
            </div>
          </div>
        </td>
        <td>
          <input type="text" placeholder="m:ss" value="${this.fmtTime(v.sec)}" 
                 onchange="app.handleDurationEdit('${v.id}', this.value)" 
                 style="font-weight:600; width:70px;">
        </td>
        <td>
          <input type="number" step="0.01" value="${v.price || ''}" placeholder="0.00"
                 onchange="app.updateRow('${v.id}','price', parseFloat(this.value)||0)" 
                 style="font-weight:600; color:var(--success); width:80px;">
        </td>
        <td>
          <input type="date" value="${v.date}" onchange="app.updateRow('${v.id}','date', this.value)" style="color:var(--muted);">
        </td>
        <td style="text-align:center;">
          <input type="checkbox" ${v.paid?'checked':''} onchange="app.updateRow('${v.id}','paid', this.checked)">
        </td>
        <td style="text-align:center;">
          <button class="icon-btn" onclick="app.deleteRow('${v.id}')">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
          </button>
        </td>
      </tr>
    `).join('') || `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--muted);">No content logged. Sync or Add Link to begin.</td></tr>`;
  },

  openModal(id) { document.getElementById(id).classList.add('open'); },
  closeModal(id) { document.getElementById(id).classList.remove('open'); },
  
  toast(msg, type="info") { 
    const t = document.getElementById('toast'); 
    t.textContent = msg; 
    t.className = `show ${type}`; 
    setTimeout(() => t.classList.remove('show'), 3000); 
  }
};

window.onload = () => app.init();
</script>
</body>
</html>
