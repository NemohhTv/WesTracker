<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Content Spend Tracker (Custom UI)</title>
<style>
  :root {
    --bg: #09090b; --card: #18181b; --border: #27272a; --text: #e4e4e7;
    --muted: #a1a1aa; --primary: #3b82f6; --danger: #ef4444; --success: #22c55e;
  }
  body { 
    margin: 0; background: var(--bg); color: var(--text); 
    font-family: system-ui, -apple-system, sans-serif; font-size: 14px; 
  }
  * { box-sizing: border-box; }

  /* --- LAYOUT --- */
  .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
  
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
  .controls { display: flex; gap: 8px; flex-wrap: wrap; }
  
  /* --- UI ELEMENTS --- */
  button, input {
    background: var(--card); border: 1px solid var(--border); color: var(--text);
    padding: 8px 12px; border-radius: 6px; font: inherit; cursor: pointer;
  }
  button:hover { border-color: var(--muted); }
  button.primary { background: var(--primary); border-color: var(--primary); color: white; }
  button.danger { color: var(--danger); border-color: var(--border); }
  input { cursor: text; }
  
  /* --- STATS GRID --- */
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
  .stat-box { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 8px; text-align: center; }
  .stat-label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px; }
  .stat-val { font-size: 24px; font-weight: 700; }
  .text-green { color: var(--success); }

  /* --- DATA TABLE --- */
  .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--card); margin-bottom: 20px; }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  thead { background: #1f1f23; }
  th { padding: 12px; text-align: left; font-size: 12px; color: var(--muted); border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  
  .thumb { width: 80px; height: 45px; background: #000; object-fit: cover; border-radius: 4px; display: block; }
  .row-title { font-weight: 600; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 250px; color: var(--text); text-decoration: none; }
  .row-chan { font-size: 12px; color: var(--muted); }

  /* --- MODALS --- */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 999;
    display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
  }
  .modal-overlay.open { display: flex; } 
  
  .modal-box {
    background: var(--card); border: 1px solid var(--border); border-radius: 12px;
    width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    display: flex; flex-direction: column;
  }
  .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .modal-head h3 { margin: 0; font-size: 16px; }
  .modal-body { padding: 20px; }
  .modal-foot { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: rgba(0,0,0,0.2); }

  /* --- CONFIRM DIALOG --- */
  .confirm-box { max-width: 400px; text-align: center; }
  .confirm-msg { margin-bottom: 20px; font-size: 16px; line-height: 1.5; }

  /* --- UTILS --- */
  .flex-col { display: flex; flex-direction: column; gap: 10px; }
  .flex-row { display: flex; gap: 10px; align-items: center; }
  .grow { flex: 1; }
  .mt { margin-top: 15px; }
  .channel-row { display: flex; justify-content: space-between; padding: 8px; background: var(--bg); border-radius: 6px; align-items: center; margin-bottom: 5px; }

  /* --- TOAST --- */
  #toast { position: fixed; bottom: 20px; right: 20px; background: var(--card); border-left: 4px solid var(--success); padding: 12px 20px; border-radius: 4px; transform: translateY(100px); transition: transform 0.3s ease; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); z-index: 1000; }
  #toast.show { transform: translateY(0); }
</style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <h1 style="margin:0; font-size:22px;">Content Spend Tracker</h1>
    <div class="controls">
      <button onclick="app.sync()" id="btnSync" class="primary">Sync Latest</button>
      <button onclick="app.addLink()">Add Link</button>
      <button onclick="ui.openModal('modalSettings')">Settings</button>
      <button onclick="app.togglePaid()" id="btnPaid">Hide Paid</button>
      <button onclick="app.exportCSV()">Export</button>
    </div>
  </div>

  <div class="stats">
    <div class="stat-box">
      <span class="stat-label">Pending</span>
      <span class="stat-val text-green" id="s-unpaid">$0.00</span>
    </div>
    <div class="stat-box">
      <span class="stat-label">Paid</span>
      <span class="stat-val" id="s-paid" style="color:var(--muted)">$0.00</span>
    </div>
    <div class="stat-box">
      <span class="stat-label">Total Lifetime</span>
      <span class="stat-val" id="s-total">$0.00</span>
    </div>
    <div class="stat-box">
      <span class="stat-label">Videos</span>
      <span class="stat-val" id="s-count">0</span>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="app.sort('title')">Video Info ↕</th>
          <th onclick="app.sort('sec')">Duration ↕</th>
          <th onclick="app.sort('price')">Price ↕</th>
          <th onclick="app.sort('date')">Date ↕</th>
          <th onclick="app.sort('paid')">Status ↕</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody">
        </tbody>
    </table>
  </div>
  
  <div style="text-align:right;">
    <button class="danger" onclick="app.requestReset()">Reset All Data</button>
  </div>
</div>

<div id="modalSettings" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Settings</h3>
      <button onclick="ui.closeModal('modalSettings')" style="border:none; background:none; font-size:18px;">✕</button>
    </div>
    <div class="modal-body flex-col">
      <label style="font-weight:bold; font-size:12px; color:var(--muted)">YOUTUBE API KEY</label>
      <input type="password" id="inpApiKey" placeholder="Paste your API Key here...">
      
      <div class="mt"></div>
      <label style="font-weight:bold; font-size:12px; color:var(--muted)">AUTO-PRICING (Minutes = $)</label>
      <div class="flex-row">
        <div class="grow"><small>8 mins</small><input type="number" id="price8" class="grow" style="width:100%"></div>
        <div class="grow"><small>9 mins</small><input type="number" id="price9" class="grow" style="width:100%"></div>
        <div class="grow"><small>10+ mins</small><input type="number" id="price10" class="grow" style="width:100%"></div>
      </div>

      <div class="mt"></div>
      <label style="font-weight:bold; font-size:12px; color:var(--muted)">TRACKED CHANNELS</label>
      <div id="chanList"></div>
      
      <div class="flex-row mt">
        <input id="inpNewChan" class="grow" placeholder="@Handle or Channel ID">
        <button class="primary" onclick="app.addChannel()" id="btnAddChan">Add</button>
      </div>

      <div class="mt" style="border-top:1px solid var(--border); padding-top:15px;">
        <label style="font-weight:bold; font-size:12px; color:var(--muted)">IGNORED VIDEOS</label>
        <div class="flex-row" style="margin-top:5px; background:var(--bg); padding:10px; border-radius:6px; border:1px solid var(--border)">
           <div class="grow">
             <span id="ignoredCount" style="font-weight:bold; display:block">0</span>
             <span style="font-size:11px; color:var(--muted)">videos hidden from Sync</span>
           </div>
           <button class="danger" onclick="app.requestClearIgnored()" style="font-size:12px">Clear List</button>
        </div>
      </div>

    </div>
    <div class="modal-foot">
      <button onclick="ui.closeModal('modalSettings')">Cancel</button>
      <button class="primary" onclick="app.saveSettings()">Save Changes</button>
    </div>
  </div>
</div>

<div id="modalConfirm" class="modal-overlay">
  <div class="modal-box confirm-box">
    <div class="modal-body">
      <h3 style="margin-top:0">Confirm Action</h3>
      <p id="confirmMsg" class="confirm-msg">Are you sure?</p>
      <div class="flex-row" style="justify-content:center; gap:20px;">
        <button onclick="ui.closeModal('modalConfirm')" style="min-width:100px">Cancel</button>
        <button id="btnConfirmYes" class="primary danger" style="min-width:100px">Yes</button>
      </div>
    </div>
  </div>
</div>

<div id="toast">Saved!</div>

<script>
/**
 * Content Spend Tracker - No Native Confirm() Version
 */
const STORAGE_KEY = 'CST_FINAL_V1';

const db = {
  data: {
    key: '',
    channels: [],
    prices: { p8: 20, p9: 25, p10: 30 },
    videos: [],
    ignored: [],
    hidePaid: false,
    sortField: 'date',
    sortDesc: true
  },
  
  load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) {
      try { 
        const parsed = JSON.parse(raw);
        this.data = { ...this.data, ...parsed };
        if(!Array.isArray(this.data.ignored)) this.data.ignored = [];
      } catch(e) { console.error("Load error", e); }
    }
  },
  
  save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
  }
};

const api = {
  async req(endpoint, params) {
    const k = document.getElementById('inpApiKey').value.trim() || db.data.key;
    if(!k) throw new Error("Missing API Key. Please check Settings.");
    
    const url = new URL(`https://www.googleapis.com/youtube/v3/${endpoint}`);
    url.search = new URLSearchParams({ key: k, ...params });
    
    const res = await fetch(url);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message);
    return json;
  },

  async resolveChannel(input) {
    const isHandle = input.startsWith('@');
    const params = { part: 'snippet,contentDetails' };
    if(isHandle) params.forHandle = input;
    else params.id = input;
    
    const data = await this.req('channels', params);
    if(!data.items?.length) throw new Error("Channel not found");
    const item = data.items[0];
    return {
      id: item.id,
      name: item.snippet.title,
      uploads: item.contentDetails.relatedPlaylists.uploads
    };
  },

  async getVideos(ids) {
    if(!ids.length) return [];
    const chunks = [];
    for (let i = 0; i < ids.length; i += 50) chunks.push(ids.slice(i, i + 50));
    let all = [];
    for(const chunk of chunks) {
      const data = await this.req('videos', { part: 'snippet,contentDetails', id: chunk.join(',') });
      if(data.items) all = all.concat(data.items);
    }
    return all;
  }
};

const app = {
  init() {
    db.load();
    ui.initInputs();
    this.render();
  },

  render() {
    ui.renderTable();
    ui.renderStats();
    ui.renderChannels();
    ui.renderIgnoredCount();
    document.getElementById('btnPaid').textContent = db.data.hidePaid ? "Show Paid" : "Hide Paid";
  },

  processVideo(apiItem) {
    const d = apiItem.contentDetails.duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
    const sec = ((parseInt(d[1])||0)*3600) + ((parseInt(d[2])||0)*60) + (parseInt(d[3])||0);
    
    const mins = Math.floor(sec/60);
    let price = 0;
    if(mins === 8) price = db.data.prices.p8;
    else if(mins === 9) price = db.data.prices.p9;
    else if(mins >= 10) price = db.data.prices.p10;

    return {
      id: apiItem.id,
      title: apiItem.snippet.title,
      chan: apiItem.snippet.channelTitle,
      date: apiItem.snippet.publishedAt.slice(0,10),
      thumb: apiItem.snippet.thumbnails?.medium?.url,
      sec: sec,
      price: price > 0 ? price : '',
      paid: false
    };
  },

  addVideoRow(vObj) {
    if(db.data.videos.some(x => x.id === vObj.id)) return false;
    const ignoreIdx = db.data.ignored.indexOf(vObj.id);
    if(ignoreIdx > -1) db.data.ignored.splice(ignoreIdx, 1);
    db.data.videos.push(vObj);
    return true;
  },

  async addLink() {
    // We use a simple prompt here as it's rarely blocked, but custom modal is cleaner.
    // For now, prompt is usually safe.
    const url = prompt("Paste YouTube URL:");
    if(!url) return;
    const match = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
    if(!match) return alert("Invalid URL");
    
    try {
      const details = await api.getVideos([match[1]]);
      if(details.length && this.addVideoRow(this.processVideo(details[0]))) {
        db.save();
        this.render();
        ui.toast("Link Added");
      } else { alert("Video not found or already exists"); }
    } catch(e) { alert(e.message); }
  },

  async addChannel() {
    const inp = document.getElementById('inpNewChan');
    const val = inp.value.trim();
    if(!val) return;
    const btn = document.getElementById('btnAddChan');
    btn.textContent = "...";
    try {
      const info = await api.resolveChannel(val);
      if(db.data.channels.some(c => c.id === info.id)) throw new Error("Already added");
      db.data.channels.push(info);
      inp.value = '';
      ui.renderChannels(); 
    } catch(e) { alert(e.message); }
    btn.textContent = "Add";
  },

  removeChannel(idx) {
    db.data.channels.splice(idx, 1);
    ui.renderChannels();
  },

  saveSettings() {
    db.data.key = document.getElementById('inpApiKey').value.trim();
    db.data.prices.p8 = parseFloat(document.getElementById('price8').value) || 0;
    db.data.prices.p9 = parseFloat(document.getElementById('price9').value) || 0;
    db.data.prices.p10 = parseFloat(document.getElementById('price10').value) || 0;
    db.save();
    ui.toast("Settings Saved");
    ui.closeModal('modalSettings');
    this.render();
  },

  // --- REPLACED CONFIRMS WITH CUSTOM MODAL ---
  requestClearIgnored() {
    ui.ask(
      `Remove ${db.data.ignored.length} videos from the ignore list? They will reappear on next Sync.`,
      () => {
        db.data.ignored = [];
        db.save();
        ui.renderIgnoredCount();
        ui.toast("Ignored List Cleared. Click Sync!");
      }
    );
  },

  async sync() {
    const btn = document.getElementById('btnSync');
    btn.disabled = true; btn.textContent = "Syncing...";
    try {
      let newCount = 0;
      for(const ch of db.data.channels) {
        const pl = await api.req('playlistItems', { playlistId: ch.uploads, maxResults: 15, part: 'contentDetails' });
        const ids = pl.items.map(x => x.contentDetails.videoId);
        const needed = ids.filter(id => !db.data.videos.some(v => v.id === id) && !db.data.ignored.includes(id));
        
        if(needed.length) {
          const details = await api.getVideos(needed);
          details.forEach(d => { if(this.addVideoRow(this.processVideo(d))) newCount++; });
        }
      }
      db.save();
      this.render();
      ui.toast(newCount === 0 ? "No new videos" : `Synced ${newCount} new`);
    } catch(e) { alert(e.message); }
    btn.disabled = false; btn.textContent = "Sync Latest";
  },

  updateRow(id, field, value) {
    const row = db.data.videos.find(v => v.id === id);
    if(row) {
      row[field] = field === 'paid' ? value : value; 
      db.save();
      this.render();
    }
  },

  // --- REPLACED CONFIRM ---
  requestDeleteRow(id) {
    ui.ask(
      "Delete this video? It will be added to the ignore list and won't sync again.",
      () => {
        if(!db.data.ignored.includes(id)) db.data.ignored.push(id);
        db.data.videos = db.data.videos.filter(v => v.id !== id);
        db.save();
        this.render();
      }
    );
  },

  togglePaid() {
    db.data.hidePaid = !db.data.hidePaid;
    db.save();
    this.render();
  },

  sort(field) {
    if(db.data.sortField === field) db.data.sortDesc = !db.data.sortDesc;
    else { db.data.sortField = field; db.data.sortDesc = true; }
    this.render();
  },

  exportCSV() {
    const head = "Date,Video,Channel,Duration,Price,Paid\n";
    const rows = db.data.videos.map(v => 
      `${v.date},"${v.title.replace(/"/g,'""')}","${v.chan}",${ui.fmtTime(v.sec)},${v.price},${v.paid?'Yes':'No'}`
    ).join("\n");
    const blob = new Blob([head + rows], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'spend_tracker.csv';
    a.click();
  },
  
  // --- REPLACED CONFIRM ---
  requestReset() {
    ui.ask(
      "Wipe ALL data? This cannot be undone.",
      () => {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    );
  }
};

const ui = {
  fmtMoney: new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' }),
  
  fmtTime(sec) {
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${m}:${s.toString().padStart(2,'0')}`;
  },

  initInputs() {
    document.getElementById('inpApiKey').value = db.data.key;
    document.getElementById('price8').value = db.data.prices.p8;
    document.getElementById('price9').value = db.data.prices.p9;
    document.getElementById('price10').value = db.data.prices.p10;
  },

  openModal(id) { document.getElementById(id).classList.add('open'); },
  closeModal(id) { document.getElementById(id).classList.remove('open'); },

  // --- NEW CUSTOM CONFIRM HANDLER ---
  ask(msg, yesCallback) {
    document.getElementById('confirmMsg').textContent = msg;
    const btn = document.getElementById('btnConfirmYes');
    
    // Clone to remove old listeners
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    
    newBtn.onclick = () => {
      yesCallback();
      this.closeModal('modalConfirm');
    };
    
    this.openModal('modalConfirm');
  },

  toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  },

  renderChannels() {
    const c = document.getElementById('chanList');
    c.innerHTML = '';
    if(!db.data.channels.length) c.innerHTML = '<div style="color:var(--muted); font-size:12px; font-style:italic;">No channels added.</div>';
    db.data.channels.forEach((ch, idx) => {
      c.innerHTML += `
        <div class="channel-row">
          <div><strong>${ch.name}</strong> <span style="font-size:10px; color:var(--muted)">(${ch.id})</span></div>
          <button class="danger" style="padding:4px 8px; font-size:11px;" onclick="app.removeChannel(${idx})">Remove</button>
        </div>
      `;
    });
  },
  
  renderIgnoredCount() {
      const c = document.getElementById('ignoredCount');
      if(c) c.textContent = `${db.data.ignored.length}`;
  },

  renderStats() {
    let un = 0, pd = 0;
    db.data.videos.forEach(v => {
      const val = parseFloat(v.price) || 0;
      if(v.paid) pd += val; else un += val;
    });
    document.getElementById('s-unpaid').textContent = this.fmtMoney.format(un);
    document.getElementById('s-paid').textContent = this.fmtMoney.format(pd);
    document.getElementById('s-total').textContent = this.fmtMoney.format(un + pd);
    document.getElementById('s-count').textContent = db.data.videos.length;
  },

  renderTable() {
    const tb = document.getElementById('tbody');
    let list = [...db.data.videos];
    if(db.data.hidePaid) list = list.filter(v => !v.paid);
    
    const f = db.data.sortField;
    const m = db.data.sortDesc ? -1 : 1;
    list.sort((a,b) => {
      let va = a[f], vb = b[f];
      if(f === 'price' || f === 'sec') { va = Number(va)||0; vb = Number(vb)||0; }
      return va > vb ? m : -m;
    });

    if(!list.length) {
      tb.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--muted)">No videos found.</td></tr>`;
      return;
    }

    tb.innerHTML = list.map(v => `
      <tr>
        <td>
          <div class="flex-row">
            <a href="https://youtu.be/${v.id}" target="_blank"><img src="${v.thumb}" class="thumb"></a>
            <div>
              <a href="https://youtu.be/${v.id}" target="_blank" class="row-title">${v.title}</a>
              <div class="row-chan">${v.chan}</div>
            </div>
          </div>
        </td>
        <td>${this.fmtTime(v.sec)}</td>
        <td><input type="number" value="${v.price}" style="width:70px" onchange="app.updateRow('${v.id}','price',this.value)"></td>
        <td><input type="date" value="${v.date}" onchange="app.updateRow('${v.id}','date',this.value)"></td>
        <td><input type="checkbox" ${v.paid?'checked':''} onchange="app.updateRow('${v.id}','paid',this.checked)"></td>
        <td><button class="danger" onclick="app.requestDeleteRow('${v.id}')">×</button></td>
      </tr>
    `).join('');
  }
};

window.onload = () => app.init();

</script>
</body>
</html>
